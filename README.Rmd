---
author:
  - name: Matthieu Stigler
    affiliation: UC Davis
    email: matthieu.stigler@gmail.com
    address: California
    url: https://matthieustigler.github.io/
  - name: Bastiaan Quast
    affiliation: The Graduate Institute, Geneva
    address: >
      Maison de la paix
      Geneva, Switzerland
    email: bquast@gmail.com
    url: http://qua.st/
title:
  formatted: "\\pkg{rddtools}: tools for Regression Discontinuity Design in R"
  plain:     "rddtools: tools for Regression Discontinuity Design in R"
  short:     "\\pkg{rddtools}"
abstract: >
  The rddtools package implements functions for handling Regression Discontinuity Design in R.
keywords:
  formatted: [RDD, Regression, Discontinuity, Design, "\\proglang{R}"]
  plain:     [RDD, Regression, Discontinuity, Design R]
preamble: >
  \usepackage{amsmath}
output:
  md_document
  
  rticles::jss_article
bibliography: bibliography.bib
---

# Introduction

The `rddtools` package address 


# Design

A unified framework is implemented through the `rdd_data` class which inherits from the `R` `base` `data.frame` class.
This functionality is made accessible throug hthe associated `rdd_data()` functions and methods.

The package is designed to leveredge of existing implementations of **Regression Discontinuity Design** in `R`, such as the `rdd` package.

It implements several variants of RDD previously not implemented.

-  Simple visualisation of the data using binned-plot: `plot()`
- Bandwidth selection:
    - MSE-RDD bandwidth procedure of [@imbens2012optimal]: `rdd_bw_ik()`
    - MSE global bandwidth procedure of [@ruppert1995effective]: `rdd_bw_rsw()`
- Estimation:
    -  RDD parametric estimation: `rdd_reg_lm()` This includes specifying the polynomial order, including covariates with various specifications as advocated in [@imbens2008regression].
    -  RDD local non-parametric estimation: `rdd_reg_np()`. Can also include covariates, and allows different types of inference (fully non-parametric, or parametric approximation). 
    -  RDD generalised estimation: allows to use custom estimating functions to get the RDD coefficient. Could allow for example a probit RDD, or quantile regression.
- Post-Estimation tools:
    - Various tools, to obtain predictions at given covariate values ( `rdd_pred()` ), or to convert to other classes, to lm ( `as.lm()` ), or to the package `np` ( `as.npreg()` ). 
    - Function to do inference with clustered data: `clusterInf()` either using a cluster covariance matrix ( **vcovCluster()** ) or by a degrees of freedom correction (as in [@cameron2008bootstrap]).
- Regression sensitivity analysis:
    - Plot the sensitivity of the coefficient with respect to the bandwith: `plotSensi()`
    - **Placebo plot** using different cutpoints: `plotPlacebo()`
- Design sensitivity analysis:
    - McCrary test of manipulation of the forcing variable: wrapper `dens_test()` to the function `DCdensity()` from package `rdd`. 
    - Test of equal means of covariates: `covarTest_mean()`
    - Test of equal density of covariates: `covarTest_dens()`
- Datasets
    - Contains the data set of Arcand [-@arcand2015development]: `indh`
    - Contains the seminal dataset of Lee [-@lee2008randomized]: `house`
    - Contains functions to replicate the Monte-Carlo simulations of [Imbens and Kalyanaraman 2012]: `gen_mc_ik()`


# Application

we use the data from the Initiative Nationale du Development Humaine (INDH) a development project in Morocco.
The data is included with the `rddtools` package under the name `indh`.

```{r, echo=FALSE, message=FALSE}
library(rddtools)
```

```{r}
data("indh")
```

Now that we have loading the data we can briefly inspect the structure of the data.

```{r}
summary(indh)
```

The `indh` object is a `data.frame` containing 729 observations (representing individuals) of three variables:

- `choice_pg` 
- `commune`
- `poverty`

The variable of interest is `choice_pg`, which represent the decision to contibute to a public good or not.
The observations are individuals choosing to contribute or not, these individuals are clustered by the variable `commune` which is the municiple structure at which funding was distributed as part of the INDH project.
The forcing variable is `poverty` which represents the number of households in a commune living below the poverty threshold.
As part of the INDH, commune with a proportion of household below the poverty threshhold greater than 30% were allowed to distribute the funding using a **Community Driven Development** scheme.
The cutoff point for our analysis is therefore `30`.

We can now transform the `data.frame` to a special `rdd_data` `data.frame` using the `rdd_data()` function.

```{r}
rdd_dat_indh <- rdd_data(y=choice_pg,
                         x=poverty,
                         data=indh,
                         cutpoint=30 )
```

The structure is similar but contains some additional information.

```{r}
str(rdd_dat_indh)
```

In order to best understand our data, we start with an exploratory data analysis using tables...

```{r}
summary(rdd_dat_indh)
```

...and plots.

```{r}
plot(rdd_dat_indh[1:715,])
```

We can now continue with a standard Regression Discontinuity Design (RDD) estimation.

```{r}
(reg_para <- rdd_reg_lm(rdd_dat_indh, order=4))
```

and visualising this estimation.

```{r}
plot(reg_para)
```

In addition to the parametric estimation, we can also perform a non-parametric estimation.

```{r}
bw_ik <- rdd_bw_ik(rdd_dat_indh)
(reg_nonpara <- rdd_reg_np(rdd_object=rdd_dat_indh, bw=bw_ik))
```

and visualising the non-parametric estimation.

```{r}
plot(reg_nonpara)
```

Sensitity tests.

```{r}
plotSensi(reg_nonpara, from=0.05, to=1, by=0.1)
```


# References
